# Use NVIDIA CUDA base image for GPU support
# Falls back gracefully to CPU if no GPU available
FROM nvidia/cuda:12.2.2-runtime-ubuntu22.04

# Install Python 3.11
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-venv \
    python3-pip \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# System dependencies for audio and building PyAV
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ffmpeg \
    libsndfile1 \
    pkg-config \
    build-essential \
    libavformat-dev \
    libavcodec-dev \
    libavdevice-dev \
    libavutil-dev \
    libswscale-dev \
    libswresample-dev \
    libavfilter-dev \
    espeak-ng \
    && rm -rf /var/lib/apt/lists/*

# Python dependencies
COPY requirements-voice.txt .
RUN pip install --no-cache-dir -r requirements-voice.txt

# Install pydub for audio conversion (Edge TTS MP3 -> WAV)
RUN pip install --no-cache-dir pydub

# Install CUDA-enabled ctranslate2 for GPU Whisper
RUN pip install --no-cache-dir ctranslate2


# Copy application
COPY voice_worker/ ./voice_worker/

# Models will be downloaded on first run
RUN mkdir -p /app/models/piper /app/models/whisper

# Set CUDA environment
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility


CMD ["python", "-m", "voice_worker.main"]
